name: Quality Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - "**/*.md"
      - "**/*.py"
      - "**/*.yml"
      - "**/*.yaml"
      - "pyproject.toml"
      - "mkdocs.yml"
      - "main.py"
  push:
    branches: [ main ]
    paths:
      - "**/*.md"
      - "**/*.py"
      - "**/*.yml"
      - "**/*.yaml"
      - "pyproject.toml"
      - "mkdocs.yml"
      - "main.py"
      - "requirements.txt"
      - "mkdocs.yml"
      - "main.py"

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  quality-check:
    name: Code Quality and Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Amazon Quick Suite Knowledge Hub
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files_yaml: |
            markdown:
              - "**/*.md"
            python:
              - "**/*.py"
            config:
              - "**/*.yml"
              - "**/*.yaml"
              - "pyproject.toml"
              - "mkdocs.yml"

      - name: Set up Python for Amazon Quick Suite Knowledge Hub
        if: steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.config_any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv package manager
        if: steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.config_any_changed == 'true'
        uses: astral-sh/setup-uv@v3

      - name: Install uv
        if: steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.config_any_changed == 'true'
        uses: astral-sh/setup-uv@v3

      - name: Install Python dependencies
        if: steps.changed-files.outputs.python_any_changed == 'true' || steps.changed-files.outputs.config_any_changed == 'true'
        run: uv sync --dev

      - name: Install Python linting tools
        if: steps.changed-files.outputs.python_any_changed == 'true'
        run: |
          uv tool install ruff
          uv tool install bandit

      - name: Lint Python files
        if: steps.changed-files.outputs.python_any_changed == 'true'
        run: |
          echo "üîç Linting Python files for Amazon Quick Suite Knowledge Hub:"
          echo "${{ steps.changed-files.outputs.python_all_changed_files }}" | tr ' ' '\n'
          uv run ruff check --output-format=github ${{ steps.changed-files.outputs.python_all_changed_files }}

      - name: Check Python code formatting
        if: steps.changed-files.outputs.python_any_changed == 'true'
        run: |
          echo "üìù Checking Python code format:"
          uv run ruff format --check ${{ steps.changed-files.outputs.python_all_changed_files }}

      - name: Run Python security scan
        if: steps.changed-files.outputs.python_any_changed == 'true'
        run: |
          echo "üîí Running security scan on Python files:"
          uv run bandit -r ${{ steps.changed-files.outputs.python_all_changed_files }} -f json || true

      - name: Lint Markdown documentation
        if: steps.changed-files.outputs.markdown_any_changed == 'true'
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            ${{ steps.changed-files.outputs.markdown_all_changed_files }}

      - name: Build MkDocs documentation
        if: steps.changed-files.outputs.config_any_changed == 'true' || steps.changed-files.outputs.markdown_any_changed == 'true'
        run: |
          echo "üìö Building Amazon Quick Suite Knowledge Hub documentation..."
          uv run mkdocs build --strict

      - name: Test MkDocs serve
        if: steps.changed-files.outputs.config_any_changed == 'true' || steps.changed-files.outputs.markdown_any_changed == 'true'
        run: |
          echo "üß™ Testing documentation server..."
          uv run mkdocs serve --dev-addr=127.0.0.1:8000 &
          sleep 5
          curl -f http://127.0.0.1:8000/ || exit 1
          pkill -f "mkdocs serve" || true

      - name: Upload documentation artifacts
        if: steps.changed-files.outputs.config_any_changed == 'true' || steps.changed-files.outputs.markdown_any_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: amazon-quick-suite-knowledge-hub-site
          path: site/
          retention-days: 7

      - name: Skip message
        if: steps.changed-files.outputs.python_any_changed == 'false' && steps.changed-files.outputs.markdown_any_changed == 'false' && steps.changed-files.outputs.config_any_changed == 'false'
        run: echo "‚è≠Ô∏è No relevant files changed - skipping quality checks for Amazon Quick Suite Knowledge Hub"
