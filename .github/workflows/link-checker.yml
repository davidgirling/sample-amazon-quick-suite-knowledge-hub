name: Link Checker

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday at midnight UTC
  pull_request:
    branches: [ main ]
    paths:
      - "**/*.md"
      - "**/*.py"
      - "**/*.js"
      - "**/*.jsx" 
      - "**/*.ts"
      - "**/*.tsx"
      - "**/package.json"
      - "mkdocs.yml"
      - "main.py"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  link-check:
    name: Amazon Quick Suite Knowledge Hub Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Amazon Quick Suite Knowledge Hub
        uses: actions/checkout@v4

      - name: Get changed documentation files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*.md
            **/*.py
            **/*.js
            **/*.jsx
            **/*.ts
            **/*.tsx
            **/package.json
            mkdocs.yml
            main.py

      - name: Set up Python for documentation build
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: astral-sh/setup-uv@v3

      - name: Install documentation dependencies
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: uv sync

      - name: Build Amazon Quick Suite Knowledge Hub documentation
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üìö Building Amazon Quick Suite Knowledge Hub documentation for link checking..."
          uv run mkdocs build

      - name: Install lychee link checker
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          # Install lychee using curl for better reliability
          curl -sSL https://github.com/lycheeverse/lychee/releases/latest/download/lychee-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          sudo mv lychee /usr/local/bin/

      - name: Check links in Amazon Quick Suite Knowledge Hub
        if: steps.changed-files.outputs.any_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üîó Checking links in Amazon Quick Suite Knowledge Hub documentation..."
          
          # Check links in built documentation site
          echo "üìö Checking links in built MkDocs site..."
          lychee --verbose --no-progress \
            --accept 200,204,206,300,301,302,303,304,307,308,403,429 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            --exclude-mail \
            './site/**/*.html' || site_exit_code=$?

          # Check links in Node.js project files
          echo "‚öõÔ∏è Checking links in Node.js project files..."
          find . -name "node_modules" -prune -o \
            \( -name "*.md" -o -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" \) \
            -path "./docs/use-cases/*" -print | \
          xargs -r lychee --verbose --no-progress \
            --accept 200,204,206,300,301,302,303,304,307,308,403,429 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            --exclude-mail || nodejs_exit_code=$?

          # Check links in Python project files
          echo "üêç Checking links in Python project files..."
          find . -name "*.py" -not -path "*/.venv/*" -not -path "*/node_modules/*" -not -path "*/cdk.out/*" -not -path "*/site/*" | \
          xargs -r lychee --verbose --no-progress \
            --accept 200,204,206,300,301,302,303,304,307,308,403,429 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            --exclude-mail || python_exit_code=$?

          # Check package.json URLs
          echo "üì¶ Checking package.json repository and homepage URLs..."
          find . -name "package.json" -not -path "./node_modules/*" | \
          xargs -r grep -l "homepage\|repository" | \
          xargs -r lychee --verbose --no-progress \
            --accept 200,204,206,300,301,302,303,304,307,308,403,429 \
            --timeout 30 \
            --retry-wait-time 5 \
            --max-retries 3 \
            --exclude-mail || package_exit_code=$?

          # Report results but don't fail workflow
          if [ ${site_exit_code:-0} -ne 0 ] || [ ${nodejs_exit_code:-0} -ne 0 ] || [ ${python_exit_code:-0} -ne 0 ] || [ ${package_exit_code:-0} -ne 0 ]; then
            echo "‚ö†Ô∏è Some links may be broken or unreachable"
            echo "This could be due to temporary network issues or rate limiting"
            echo "Please review the output above for actual broken links"
            # Don't fail the workflow for link checker issues
            exit 0
          else
            echo "‚úÖ All links in Amazon Quick Suite Knowledge Hub are valid"
          fi

      - name: Skip message
        if: steps.changed-files.outputs.any_changed == 'false' && github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è No documentation files changed - skipping link check for Amazon Quick Suite Knowledge Hub"
