name: Node.js Quality Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/*.js"
      - "**/*.jsx"
      - "**/*.ts"
      - "**/*.tsx"
      - "**/tsconfig.json"
      - "**/.eslintrc*"
      - "**/next.config.*"
      - "**/tailwind.config.*"
  push:
    branches: [ main ]
    paths:
      - "**/package.json"
      - "**/package-lock.json"
      - "**/*.js"
      - "**/*.jsx"
      - "**/*.ts"
      - "**/*.tsx"
      - "**/tsconfig.json"
      - "**/.eslintrc*"
      - "**/next.config.*"
      - "**/tailwind.config.*"

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  nodejs-quality-check:
    name: Node.js Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Amazon Quick Suite Knowledge Hub
        uses: actions/checkout@v4

      - name: Get changed Node.js files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files_yaml: |
            nodejs:
              - "**/package.json"
              - "**/package-lock.json"
              - "**/*.js"
              - "**/*.jsx"
              - "**/*.ts"
              - "**/*.tsx"
              - "**/tsconfig.json"
              - "**/.eslintrc*"
              - "**/next.config.*"
              - "**/tailwind.config.*"

      - name: Check for Node.js projects
        if: steps.changed-files.outputs.nodejs_any_changed == 'true'
        id: check-nodejs
        run: |
          if find . -name "package.json" -not -path "./node_modules/*" | grep -q .; then
            echo "has_nodejs=true" >> $GITHUB_OUTPUT
          else
            echo "has_nodejs=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.changed-files.outputs.nodejs_any_changed == 'true' && steps.check-nodejs.outputs.has_nodejs == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Find Node.js projects
        if: steps.changed-files.outputs.nodejs_any_changed == 'true' && steps.check-nodejs.outputs.has_nodejs == 'true'
        id: find-projects
        run: |
          echo "üîç Finding Node.js projects in Amazon Quick Suite Knowledge Hub..."
          projects=$(find . -name "package.json" -not -path "./node_modules/*" | xargs dirname | sort -u)
          echo "projects<<EOF" >> $GITHUB_OUTPUT
          echo "$projects" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Found projects:"
          echo "$projects"

      - name: Install dependencies and run quality checks
        if: steps.changed-files.outputs.nodejs_any_changed == 'true' && steps.check-nodejs.outputs.has_nodejs == 'true'
        run: |
          echo "üì¶ Installing dependencies and running quality checks..."
          while IFS= read -r project; do
            if [ -f "$project/package.json" ]; then
              echo "üîß Processing project: $project"
              cd "$project"
              
              # Install dependencies
              echo "üì• Installing dependencies for $project"
              npm ci || npm install
              
              # Run linting if available
              if npm run lint --silent 2>/dev/null; then
                echo "üîç Running ESLint for $project"
                npm run lint
              else
                echo "‚ö†Ô∏è No lint script found for $project"
              fi
              
              # Run build if available
              if npm run build --silent 2>/dev/null; then
                echo "üèóÔ∏è Building project $project"
                npm run build
              else
                echo "‚ö†Ô∏è No build script found for $project"
              fi
              
              # Run type checking for TypeScript projects
              if [ -f "tsconfig.json" ]; then
                echo "üìù Running TypeScript check for $project"
                npx tsc --noEmit
              fi
              
              cd - > /dev/null
            fi
          done <<< "${{ steps.find-projects.outputs.projects }}"

      - name: Skip message
        if: steps.changed-files.outputs.nodejs_any_changed == 'false'
        run: echo "‚è≠Ô∏è No Node.js files changed - skipping Node.js quality checks for Amazon Quick Suite Knowledge Hub"
